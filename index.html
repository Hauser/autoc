<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Autocorrelation</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="autoc.js" type="text/javascript"></script>
    <script type="text/babel">
        var config = {
            min: -1,
            max: 1,
            range: [-150, 150],
            frequency: 1 / 100,
            part: [-50, 50],
            tps: 25,
        };
        var plotConfig = {
            responsive: true,
        };
        var plotConfigC = {
            ...plotConfig,
        };
        var plotLayout = {
            title: 'y[x], y[x+Ï„]',
            legend: {
                x: 1,
                y: 0.5,
            },
            xaxis: {
                range: config.range,
            },
            yaxis: {
                range: [config.min + config.min / 10, config.max + config.max / 10],
            },
        };
        var plotLayoutC = {
            ...plotLayout,
            legend: {
                x: 1,
                y: 0.5,
            },
            title: 'c[x]',
        };
        var colors = undefined;
        {
            const d3Colors = Plotly.d3.scale.category10();
            colors = {
                blue: d3Colors(0),
                orange: d3Colors(1),
                green: d3Colors(2),
            };
        }

        const createTime = (length, offset = 0) => {
            return Array.from(Array(length * 2).keys())
                .map(x => x + offset);
        };
        const mirror = (data) => {
            let temp = [...data].slice(1);
            return [...data.reverse(), ...temp];
        };
        const sineWave = (range, f) => {
            const [a, b] = range;
            let wave = [];
            for (let i = a; i < b; ++i) {
                wave.push(1/2*(Math.sin(2*Math.PI*f*i) + Math.sin(2*2*Math.PI*f*i)));
            }
            return wave;
        };

        const samples = sineWave(config.range, config.frequency);

        const defaultData = [
            {
                y: samples,
                x: createTime(samples.length, -(samples.length / 2)),
                name: 'y[x]',
                line: {
                    shape: 'spline',
                },
                mode: 'lines',
            },
            {
                y: samples.slice(samples.length / 2 + config.part[0], samples.length / 2 + config.part[1]),
                x: createTime(samples.length, -(samples.length - 1) - (samples.length / 2)),
                name: `y[x+${samples.length - 1}]`,
                line: {
                    shape: 'spline',
                },
                mode: 'lines',
            },
        ];
        const defaultC = [
            {
                y: [],
                x: [],
                name: `c[x] (0)`,
                line: {
                    shape: 'spline',
                },
                mode: 'lines',
                showlegend: true,
                marker: {
                    color: colors.green,
                }
            }
        ];

        const Plot = ({ data, layout, config }) => {
            const ref = React.createRef();

            React.useEffect(() => {
                Plotly.newPlot(ref.current, data, layout, config);
            });

            return (
                <div ref={ref} />
            )
        };

        const App = () => {
            const autoShift = React.createRef();

            const [ data, setData ] = React.useState(defaultData);
            const [ c, setC ] = React.useState(defaultC);
            const [ tau, setTau ] = React.useState(-(samples.length / 2) + defaultData[1].y.length / 2);
            const [ animate, setAnimate ] = React.useState(false);

            const fetchNew = async () => {
                console.log('api call: www.random.org');

                const { range, min, max } = config;
                const amount = Math.abs(range[0]) + range[1];

                let res = await fetch(`https://www.random.org/integers/?num=${amount}&min=${min}&max=${max}&col=1&base=10&format=plain&rnd=new`);
                let txt = await res.text();
                let data = txt.split('\n');
                data.pop();

                //plotLayout.xaxis.range = plotLayoutC.xaxis.range = [-(amount + (amount / 2)), amount + (amount / 2)];
                //plotLayout.yaxis.range = plotLayoutC.yaxis.range = [min - (Math.abs(min) / 10), max + (max / 10)];

                let data2 = data.slice(data.length / 2 + config.part[0], data.length / 2 + config.part[1]);

                setData([
                    {
                        ...defaultData[0],
                        y: data,
                        x: createTime(amount, -(amount / 2)),
                    },
                    {
                        ...defaultData[1],
                        y: data2,
                        x: createTime(data2.length, -(data2.length / 2) ),
                    }
                ]);
                setC([
                    {
                        ...defaultC[0],
                    }
                ]);
                setTau(-(data.length / 2) + data2.length / 2);
            };

            const shift = (direction) => (a, b) => {
                let source = [...data[0].y];
                let shifted = [...data[1].y];

                let newTau = (direction === 'right')
                    ? (tau + 1 < (source.length / 2) - (shifted.length / 2) ? tau + 1 : -((source.length / 2) - (shifted.length / 2)))
                    : (tau - 1 > -((source.length / 2) - (shifted.length / 2)) ? tau - 1 : (source.length / 2) - (shifted.length / 2));

                let index = 0;
                if (newTau < 0) {
                    index = newTau + (source.length / 2) - (shifted.length / 2);
                    source = source.slice(index, index + shifted.length);
                    //console.log('a', index);
                } else if (newTau >= 0) {
                    index = newTau + (source.length / 2) - (shifted.length / 2);
                    //console.log('b', index);
                    source = source.slice(index, index + shifted.length);
                }

                //console.log(index, source.length, shifted.length);

                let newC = crossCorrelation(source, shifted, true, true);

                data[1].name = `y[x${newTau <= 0 ? '+' : '-'}${Math.abs(newTau)}]`;
                data[1].x = createTime(data[1].y.length, newTau - (data[1].y.length / 2));

                c[0].y = newC;
                c[0].x = createTime(newC.length, (!autoShift.current.checked) ? newTau - data[1].y.length + 1 : -((newC.length + 1) / 2) + 1);
                c[0].name = `c[x] (${newC.length})`;

                setData(data);
                setC(c);
                setTau(newTau);
            };

            const toggleAnimation = () => () => {
                setAnimate(!animate);
            };

            React.useEffect(() => {
                let timeout = undefined;
                if (animate) {
                    timeout = setTimeout(() => shift('right')(), config.tps);
                } else {
                    clearTimeout(timeout);
                }
                return () => clearTimeout(timeout);
            }, [tau, animate]);

            return (
                <React.Fragment>
                    <button onClick={fetchNew}>Fetch</button>
                    <button onClick={toggleAnimation()}>Animate</button>
                    <button onClick={shift('left')}>Left</button>
                    <button onClick={shift('right')}>Right</button><br /><br />
                    <input ref={autoShift} type="checkbox" defaultChecked={true} />Auto Shift<br />
                    <Plot data={data} layout={plotLayout} config={plotConfig} />
                    <Plot data={c} layout={plotLayoutC} config={plotConfigC} />
                </React.Fragment>
            )
        };

	    ReactDOM.render(<App />, document.querySelector('#root'));
    </script>
</body>

</html>