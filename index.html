<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Autocorrelation</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="autoc.js" type="text/javascript"></script>
    <script type="text/babel">
        var plotConfig = {
            responsive: true,
        };
        var plotConfigC = {
            ...plotConfig,
        };
        var plotLayout = {
            title: 'y[x], y[x+Ï„]',
            legend: {
                x: 1,
                y: 0.5,
            },
            xaxis: {
                range: [-150, 150],
            },
            yaxis: {
                range: [-10, 110],
            },
        };
        var plotLayoutC = {
            ...plotLayout,
            title: 'c[x]',
        };
        var apiConfig = {
            amount: 100,
            min: -1000,
            max: 1000,
        };
        var colors = undefined;
        {
            const d3Colors = Plotly.d3.scale.category10();
            colors = {
                blue: d3Colors(0),
                orange: d3Colors(1),
                green: d3Colors(2),
            };
        }
        var animationSpeed = 75;

        const matrix = (str) => {
            return str[0]
                .split(/\s+/)
                .filter(s => s !== '');
        };
        const createTime = (length, offset = 0) => {
            return Array.from(Array(length * 2).keys())
                .map(x => x + offset);
        };
        const mirror = (data) => {
            let temp = [...data].slice(1);
            return [...data.reverse(), ...temp];
        };

        const samples = matrix`
            35	30	34	92	100
            17	36	89	72	35
            95	33	44	83	58
            21	56	3	6	56
            45	38	47	64	14
            36	97	100	81	78
            52	5	21	40	90
            97	13	66	21	15
            69	85	83	27	38
            71	53	8	39	1
            72	93	77	60	92
            99	53	43	25	75
            87	45	36	54	46
            29	57	24	52	62
            81	72	33	100	36
            38	100	58	83	15
            45	92	86	62	40
            25	81	59	61	61
            86	31	3	46	93
            27	1	30	19	94
        `;

        const defaultData = [
            {
                y: samples,
                x: createTime(samples.length, -(samples.length / 2)),
                name: 'y[x]',
                line: {
                    shape: 'spline',
                },
                mode: 'lines',
            },
            {
                y: samples,
                x: createTime(samples.length, -(samples.length - 1) - (samples.length / 2)),
                name: `y[x+${samples.length - 1}]`,
                line: {
                    shape: 'spline',
                },
                mode: 'lines',
            },
        ];
        const defaultC = [
            {
                y: [],
                x: [],
                name: `c[x] (0)`,
                line: {
                    shape: 'spline',
                },
                mode: 'lines',
                showlegend: true,
                marker: {
                    color: colors.green,
                }
            }
        ];

        const Plot = ({ data, layout, config }) => {
            const ref = React.createRef();

            React.useEffect(() => {
                Plotly.newPlot(ref.current, data, layout, config);
            });

            return (
                <div ref={ref} />
            )
        };

        const App = () => {
            const autoShift = React.createRef();

            const [ data, setData ] = React.useState(defaultData);
            const [ c, setC ] = React.useState(defaultC);
            const [ tau, setTau ] = React.useState(-samples.length);
            const [ animate, setAnimate ] = React.useState(false);

            const fetchNew = async () => {
                console.log('api call: www.random.org');

                const { amount, min, max } = apiConfig;

                let res = await fetch(`https://www.random.org/integers/?num=${amount}&min=${min}&max=${max}&col=1&base=10&format=plain&rnd=new`);
                let txt = await res.text();
                let data = txt.split('\n');
                data.pop();

                plotLayout.xaxis.range = plotLayoutC.xaxis.range = [-(amount + (amount / 2)), amount + (amount / 2)];
                plotLayout.yaxis.range = plotLayoutC.yaxis.range = [min - (Math.abs(min) / 10), max + (max / 10)];

                setData([
                    {
                        ...defaultData[0],
                        y: data,
                        x: createTime(amount, -(amount / 2)),
                    },
                    {
                        ...defaultData[1],
                        y: data,
                        x: createTime(amount, -(amount - 1) - (amount / 2)),
                    }
                ]);
                setC([
                    {
                        ...defaultC[0],
                    }
                ]);
                setTau(-data.length);
            };

            const shift = (direction) => (a, b) => {
                let source = [...data[0].y];
                let shifted = [...data[0].y];

                let newTau = (direction === 'right')
                    ? (tau + 1 < source.length ? tau + 1 : -source.length + 1)
                    : (tau - 1 > -source.length ? tau - 1 : source.length);

                if (newTau < 0) {
                    source.splice(newTau);
                    shifted.splice(0, -newTau);
                } else if (newTau > 0) {
                    source.splice(0, newTau);
                    shifted.splice(-newTau);
                }

                let newC = crossCorrelation(source, shifted, true, true);

                data[1].name = `y[x${newTau <= 0 ? '+' : '-'}${Math.abs(newTau)}]`;
                data[1].x = createTime(data[0].y.length, newTau - (data[0].y.length / 2));

                c[0].y = newC;
                c[0].x = createTime(newC.length, (!autoShift.current.checked) ? -data[0].y.length + 1 : -((newC.length + 1) / 2) + 1);
                c[0].name = `c[x] (${newC.length})`;

                setData(data);
                setC(c);
                setTau(newTau);
            };

            const toggleAnimation = () => () => {
                setAnimate(!animate);
            };

            React.useEffect(() => {
                let timeout = undefined;
                if (animate) {
                    timeout = setTimeout(() => shift('right')(), animationSpeed);
                } else {
                    clearTimeout(timeout);
                }
                return () => clearTimeout(timeout);
            }, [tau, animate]);

            return (
                <React.Fragment>
                    <button onClick={fetchNew}>Fetch</button>
                    <button onClick={toggleAnimation()}>Animate</button>
                    <button onClick={shift('left')}>Left</button>
                    <button onClick={shift('right')}>Right</button><br /><br />
                    <input ref={autoShift} type="checkbox" defaultChecked={true} />Auto Shift<br />
                    <Plot data={data} layout={plotLayout} config={plotConfig} />
                    <Plot data={c} layout={plotLayoutC} config={plotConfigC} />
                </React.Fragment>
            )
        };

	    ReactDOM.render(<App />, document.querySelector('#root'));
    </script>
</body>

</html>