<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>Autocorrelation</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>

<body>
    <div id="root"></div>
    <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
    <script src="autoc.js" type="text/javascript"></script>
    <script type="text/babel">
        var config = {
            min: -1,
            max: 1,
            range: [-150, 150],
            frequency: 1 / 100,
            part: [-50, 50],
            tps: 25,
        };
        var plotConfig = {
            responsive: true,
        };
        var plotConfigC = {
            ...plotConfig,
        };
        var plotLayout = {
            title: 'y[n+τ]',
            legend: {
                x: 1,
                y: 0.5,
            },
            xaxis: {
                range: config.range,
            },
            yaxis: {
                range: [config.min + config.min / 10, config.max + config.max / 10],
            },
            font: {
                size: 18,
            },
        };
        var plotLayoutC = {
            ...plotLayout,
            legend: {
                x: 1,
                y: 0.5,
            },
            title: 'c[n]',
        };
        var colors = undefined;
        {
            const d3Colors = Plotly.d3.scale.category10();
            colors = {
                blue: d3Colors(0),
                orange: d3Colors(1),
                green: d3Colors(2),
            };
        }

        const createTime = (length, offset = 0) => {
            return Array.from(Array(length * 2).keys())
                .map(x => x + offset);
        };
        const genWave = (range, f) => {
            const [a, b] = range;
            const omega = 2 * Math.PI * f;
            let wave = [];
            for (let n = a; n < b; ++n) {
                wave.push(1/2*(Math.sin(n*omega) + Math.sin(2*n*omega)));
            }
            return wave;
        };

        const wave = genWave(config.range, config.frequency);
        const defaultData = [
            {
                y: wave,
                x: createTime(wave.length, -(wave.length / 2)),
                name: 'x[n]',
                line: {
                    shape: 'spline',
                    width: 4,
                },
                mode: 'lines',
            },
            {
                y: wave.slice(wave.length / 2 + config.part[0], wave.length / 2 + config.part[1]),
                x: createTime(wave.length, -(wave.length - 1) - (wave.length / 2)),
                name: `y[n+τ]`,
                line: {
                    shape: 'spline',
                    width: 4,
                },
                mode: 'lines',
            },
        ];
        const defaultC = [
            {
                y: [],
                x: [],
                name: `c[n]`,
                line: {
                    shape: 'spline',
                    width: 4,
                },
                mode: 'lines',
                showlegend: true,
                marker: {
                    color: colors.green,
                }
            }
        ];

        const Plot = ({ data, layout, config }) => {
            const ref = React.createRef();

            React.useEffect(() => {
                Plotly.newPlot(ref.current, data, layout, config);
            });

            return (
                <div ref={ref} />
            )
        };

        const App = () => {
            const autoShift = React.createRef();

            const [ data, setData ] = React.useState(defaultData);
            const [ c, setC ] = React.useState(defaultC);
            const [ tau, setTau ] = React.useState(-(wave.length / 2) + defaultData[1].y.length / 2);
            const [ animate, setAnimate ] = React.useState(false);

            const fetchNew = async () => {
                console.log('api call: www.random.org');

                const { range, min, max } = config;
                const amount = Math.abs(range[0]) + range[1];

                let res = await fetch(`https://www.random.org/integers/?num=${amount}&min=${min}&max=${max}&col=1&base=10&format=plain&rnd=new`);
                let txt = await res.text();
                let data = txt.split('\n');
                data.pop();

                //plotLayout.xaxis.range = plotLayoutC.xaxis.range = [-(amount + (amount / 2)), amount + (amount / 2)];
                //plotLayout.yaxis.range = plotLayoutC.yaxis.range = [min - (Math.abs(min) / 10), max + (max / 10)];

                let data2 = data.slice(data.length / 2 + config.part[0], data.length / 2 + config.part[1]);

                setData([
                    {
                        ...defaultData[0],
                        y: data,
                        x: createTime(amount, -(amount / 2)),
                    },
                    {
                        ...defaultData[1],
                        y: data2,
                        x: createTime(data2.length, -(data2.length / 2)),
                    }
                ]);
                setC([{ ...defaultC[0] }]);
                setTau(-(data.length / 2) + data2.length / 2);
            };

            const next = (direction) => () => {
                let x = data[0].y;
                let y = data[1].y;

                let limit = (x.length / 2) - (y.length / 2);

                let newTau = (direction === 'right')
                    ? (tau + 1 < limit ? tau + 1 : -limit)
                    : (tau - 1 >= -limit ? tau - 1 : limit);

                let index = newTau + limit;
                let newC = crossCorrelation(x.slice(index, index + y.length), y, true, true);

                plotLayout.title = `y[n${newTau <= 0 ? '+' : '-'}${Math.abs(newTau)}]`;

                data[1].x = createTime(y.length, newTau - (y.length / 2));

                let shift = (autoShift.current && !autoShift.current.checked) ? newTau - y.length + 1 : -((newC.length + 1) / 2) + 1;
                c[0].y = newC;
                c[0].x = createTime(newC.length, shift);

                setData(data);
                setC(c);
                setTau(newTau);
            };

            const toggleAnimation = () => () => {
                setAnimate(!animate);
            };

            React.useEffect(() => {
                let timeout = undefined;
                if (animate) {
                    timeout = setTimeout(() => next('right')(), config.tps);
                } else {
                    clearTimeout(timeout);
                }
                return () => clearTimeout(timeout);
            }, [tau, animate]);

            return (
                <React.Fragment>
                    <button onClick={fetchNew}>Fetch</button>
                    <button onClick={toggleAnimation()}>Animate</button>
                    <button onClick={next('left')}>Left</button>
                    <button onClick={next('right')}>Right</button><br /><br />
                    <input ref={autoShift} type="checkbox" defaultChecked={true} />Auto Shift<br />
                    <Plot data={data} layout={plotLayout} config={plotConfig} />
                    <Plot data={c} layout={plotLayoutC} config={plotConfigC} />
                </React.Fragment>
            )
        };

	    ReactDOM.render(<App />, document.querySelector('#root'));
    </script>
</body>

</html>